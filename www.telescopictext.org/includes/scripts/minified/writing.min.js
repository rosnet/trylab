/*
 * writing.js (minified)
 * 
 * javascript writing system for Telescopic Text
 * http://www.telescopictext.org/
 *
 * Date: 15th of December 2010
 * Version: 0.9.7
 *
 * Copyright (c) 2010 Joe Davis
 * 
 */

$(document).ready(function(){set_up()});var id_counter=0,help=true,get_saved_text_list_queued=false,text_started=false,editing=true,deleting="off",unsaved_changes=0,allow_save=false,allow_delete=false,allow_duplicate=false,allow_publish=false,allow_revert=false,allow_fold=false,allow_unfold=false,allow_empty=true,allow_preview=true,allow_help=true,appending=false,key_pressed=false,dummy_text="Type words here...",initial_text=false,maximum_starting_length=140,line_break="<span class='line_break'><br /><br /></span>",global_key=0,Message=new messageClass(),Allow=new allowClass(),current_mouse_over;window.onbeforeunload=confirm_exit;function confirm_exit(){if(unsaved_changes>0){return"Any unsaved changes will be lost if you navigate away."}else{return}}function make_draggable(a){$(".text_structure").draggable("destroy");$(a+" .text_structure").draggable({stop:function(){var g=$(this),i=20,f=new Object,b=g.parent().parent(),h=i-g.position().top,c=b.height()-g.position().top-g.outerHeight()+i,e=i-g.position().left,j=b.width()-g.position().left-g.outerWidth()+i,d=b.width()-g.outerWidth(),k=b.height()-g.outerHeight();if(j>0&&e>=0){if(d<0){f.left=b.width()-g.outerWidth()-20}else{f.left=0}}else{if(e<0){f.left=0}}if(c>0&&h>=0){if(k<0){f.top=b.height()-g.outerHeight()-20}else{f.top=0}}else{if(h<0){f.top=0}}if(f.left!=undefined||f.top!=undefined){g.animate(f,100)}}})}function set_up(){$(window).resize(function(){});$("#empty_btn").hide();$(".structure_title.remove .structure_title_text span").live("mouseover",function(){$(this).parent().parent().parent().addClass("remove_selected")}).live("mouseout",function(){$(this).parent().parent().parent().removeClass("remove_selected")}).live("click",function(){var b=$(this).parent().parent().parent(),a=b.html(),c=b.attr("id").replace("s","");$("#message_text_structure_window").show();$("#text_structure_window .text_structure_container").clone().appendTo("#message_text_structure_window");$("#message_text_structure_window .text_structure").html(a).css({left:"0",top:"0"});$("#message_text_structure_window .text_structure>.structure_title").hide();$("#message_text_structure_window .structure_title").removeClass("remove");make_draggable("#message_text_structure_window");Message.html("<h2>Are you sure you want to remove the following text?</h2>");Message.cancel("Cancel");Message.ok("Remove","remove","red wide");$("#msg_remove").click(function(){Message.hide();$("#message_text_structure_window").empty().hide();make_draggable("#text_structure_window");empty(c)});$(".cancelmessage, #close_message_box").click(function(){$("#message_text_structure_window").empty().hide();make_draggable("#text_structure_window")});Message.show()});make_draggable("#text_structure_window");$(".break").live("click",function(){unbridge($(this));return false}).live("mouseover",function(){$(this).parent().css("outline","1px solid #888")}).live("mouseout",function(){$(this).parent().css("outline","")});$(".text").live("click",function(){enter($(this))});$(".join").live("click",function(){bridge($(this))}).live("mouseover",function(){roll_over_gap($(this))}).live("mouseout",function(){roll_out_gap($(this))});register_help("#story_title","The title of your Text",-60);register_help("#last_saved","When you last saved",-60);register_help("#revert_btn","Revert to saved version",-60);register_help("#secondary_delete_btn","Permanently delete this Telescopic Text",-60);register_help("#secondary_preview_btn","Preview this Telescopic Text",-60);register_help("#duplicate_btn","Save a duplicate copy of this Telescopic Text",-60);register_help("#back_to_editing","Bring back the editing tools",-60);register_help("#view_structure","View structure",-60);register_help("#view_split","View structure and text",-60);register_help("#view_normal","View text",-60);register_help("#oldinner","Put the previous text back");register_help("#textinput","Write new words in here",40);register_help("#add","Place new text inside existing text");register_help("#canceladd","Don't insert text");register_help("#new_btn","Start a new Telescopic Text");register_help("#startagain_btn","Erase the current Telescopic Text and start a new one");register_help("#open_btn","Open a saved Telescopic Text");register_help("#fold_btn","Fold all text");register_help("#unfold_btn","Unfold all text");register_help("#undo_btn","Undo the last edit");register_help("#redo_btn","Redo the last undo");register_help("#help_btn","Turn these hints off");register_help("#save_btn","Save your Telescopic Text for editing again later");register_help("#publish_btn","Publish your Telescopic Text");register_help("#delete_btn","Permanently delete this Telescopic Text");register_help("#read_btn","Hide the editing tools and preview this Telescopic Text");register_help("#empty_btn","Empty words of their 'contents'");register_help("#register_btn","Register to save, publish and manage your Telescopic Texts");register_help(".join","Click to join these words up");register_help(".break","Click to break these words apart");register_help(".text","Click to place new text inside this text");register_help(".b","Click to unfold this word or phrase");register_help(".structure_title.remove .structure_title_text>span","Click to delete the contents of this word or phrase",-60);register_help("._node_content","Click to fold this word or phrase");$(window).keydown(function(a){key_pressed=true;global_key=a.which}).keyup(function(a){key_pressed=false;global_key=0});$("#firsttextinput").live("keyup",function(){initial_text=true;var a=$(this),b=a.val();if(b.length>maximum_starting_length){a.val(b.substr(0,maximum_starting_length));warning("#firsttextinput","Too many letters")}});$("#textinput").live("keydown",function(b){var a=$(this);if(b.which==8||b.which==46){if(a.html()!="&nbsp;"&&a.text().length==1){a.append("&nbsp;")}else{if(a.text().length==0){a.append("&nbsp;")}}}return b}).live("keyup",function(c){var a=$(this),b=a.html();if(b.match(/(<br>)+(?=\&nbsp;)|(<br>)+$/)){b=b.replace(/(<br>)+(?=\&nbsp;)|(<br>)+$/g,"");if(b==""){b="&nbsp;"}}if(b.match(/<(?!br \/>|br>)[^>]*>/)){b=b.strip_html_tags();b=b.replace(/&nbsp;/g," ")}if(b!=a.html()){a.html(b);set_caret()}});$(".b, ._node_title").live("click",function(){expand($(this).parent())});$("input#firsttextinput").focus(function(){var a=$(this);if(a.val()==dummy_text&&initial_text==false){a.attr("value","");a.css("color","#000")}}).blur(function(){var a=$(this);if(a.val()==""){initial_text=false;a.css("color","#BBB");a.val(dummy_text)}});$(".delete, .really_delete").live("mouseover",function(){$(this).parent().parent().children(".story_title").addClass("red")}).live("mouseout",function(){$(this).parent().parent().children(".story_title").removeClass("red")});reset();backwards_mode();$("#firsttextinput").focus()}function roll_over_gap(a){current_mouse_over=a;a.prev().addClass("text_hover");a.next().addClass("text_hover")}function roll_out_gap(a){a.prev().removeClass("text_hover");a.next().removeClass("text_hover");current_mouse_over=""}function set_caret(a){var e=$("#textinput").text(),b=document.createRange(),d=document.getElementById("textinput"),c;$("#textinput").text(e);switch(a){case"start":b.setStart(d,0);b.setEnd(d,0);break;case"end":b.setStart(d,1);b.setEnd(d,1);break;case"all":b.setStart(d,0);b.setEnd(d,1);break;default:b.setStart(d,1);b.setEnd(d,1)}c=window.getSelection();c.removeAllRanges();c.addRange(b);d.focus()}function reset(){$("input#firsttextinput").val("");$("input#firsttextinput").css("color","#BBB");$("input#firsttextinput").val(dummy_text);initial_text=false;$("#thetelescopictext").val("");$("#story_id").val("");$("#title").val("");$("#author").val("");$("#author_id").val("");$("#first_save").val("1");$("#private").val("0");$("#story_id").val("");unsaved_changes=0;view_normal();text_started=false}function register_help(b,c,a){$(b).live("mouseover",function(){if(help==true?allow_help==true:false){var e=c.replace(/ /g,"&nbsp;"),g=$(this),i=g.offset(),d=g.outerHeight()+10,h,f;if(a!=undefined){d=d+a}$("#help").css({top:i.top+d,left:i.left});$("#help").html(e);$("#help").show();h=$("#help").position().left+$("#help").outerWidth();if(h>($("#tt_editing").width()-36)){f=$("#tt_editing").width()-36-$("#help").outerWidth();$("#help").css("left",f)}}return false}).live("mouseout",function(){if(help==true){$("#help").hide()}})}function warning(e,h,d){$("#alert").stopTime();var b=h.replace(/ /g,"&nbsp;"),g=$(e).offset(),a=$(e).outerHeight()+10,f,c;if(d!=undefined){a=a+d}$("#alert").css({top:g.top+a,left:g.left});$("#alert").html(b);$("#alert").show();f=$("#alert").position().left+$("#alert").outerWidth();if(f>$("#story").outerWidth()){c=$("#story").width()+36-$("#alert").outerWidth();$("#alert").css("left",c)}$("#alert").oneTime(2000,function(){$(this).hide()})}function help_toggle(){if(help==true){help=false;$("#help").hide();$("#help_btn").addClass("helpoff").removeClass("help")}else{if(help==false){help=true;$("#help").show();$("#help_btn").addClass("help").removeClass("helpoff")}}}function time_since_last_save(){time_since("Saved","Last saved "," ago")}function time_since_started(){time_since("Unsaved","Unsaved for ","")}function time_since_opened(){time_since("Opened","Opened "," ago")}function time_since(c,e,f){$(document).stopTime("time_since");var b=0,d,a;$("#last_saved").css("color","#888").text(c);$(document).everyTime("60s","time_since",function(){b++;if(b>59){hours=Math.floor(b/60);hrs_minutes=b-(hours*60);if(hours==1){d=" hour and "}if(hours!=1){d=" hours and "}if(hrs_minutes==1){a=" minute"}if(hrs_minutes!=1){a=" minutes"}$("#last_saved").text(e+hours+d+hrs_minutes+a+f)}else{if(b==1){$("#last_saved").text(e+b+" minute"+f)}if(b!=1){$("#last_saved").text(e+b+" minutes"+f)}}});$("<span></span>").appendTo("#last_saved")}function check_folded(){var b=true,a=true;$(".c").each(function(){if($(this).is(":not(:visible)")){a=false}});$(".c").each(function(){if($(this).is(":visible")){b=false}});if(b==true){Allow.fold(false)}else{Allow.fold(true)}if(a==true){Allow.unfold(false)}else{Allow.unfold(true)}}function messageClass(){this.show=function(a){cancel_append();$(document).keydown(function(b){if(b.which==27?$("#floating_login:hidden")&&$("#message_background:visible"):false){Message.hide()}});$("#story").css("position","fixed");$("#close_message_box").click(function(){Message.hide()});if($("#message_background").is(":not(:visible)")){$("#message_background").show().fadeTo(0,0).fadeTo(150,0.6);$("#message_positioner").show().fadeTo(0,0).fadeTo(150,1,function(){if(a=="save"){really_save()}else{if(a=="publish"){really_save_for_publish()}}})}else{if(a=="save"){really_save()}else{if(a=="publish"){really_save_for_publish()}}}};this.hide=function(){$("#message_background").fadeOut(200);$("#message_positioner").fadeOut(200,function(){Message.empty();$("#story").css("position","")})};this.empty=function(){$("#message_content").empty();$("#options").empty()};this.cancel=function(a){$("<span>"+a+"</span>").attr({"class":"button cancelmessage"}).appendTo("#options");$(".cancelmessage").click(function(){Message.hide()})};this.ok=function(a,c,b){b=" "+b;$("<span>"+a+"</span>").attr({id:"msg_"+c,"class":"button blue"+b}).appendTo("#options")};this.html=function(a){Message.empty();$("#message_content").html(a)}}function save_response(a){saved(a);if(get_saved_text_list_queued==true){get_saved_text_list()}else{Message.hide()}}function saved(a){$("#first_save").val("0");$("#story_id").val(a);$("#publish_story_id").val(a);time_since_last_save();Allow.Delete(true);Allow.revert(true);Allow.duplicate(true);unsaved_changes=0}function publish_response(a){window.location=TT_URL+"text/"+a}function restart_signed_in(){if(allow_save==true?unsaved_changes==0:false){Message.html("<h2>Save before starting a new Text?</h2>");Message.cancel("Cancel");Message.ok("Don't save","dontsave","wide");Message.ok("Save","save","wide");$("#msg_save").click(function(){save();start_new_text();Message.hide()});$("#msg_dontsave").click(function(){start_new_text();Message.hide()});Message.show()}else{cancel_append();start_new_text()}}function restart(){if(unsaved_changes!=0){Message.html("<h2>Are you sure you want to erase the current Telescopic Text and start a new one?</h2>");Message.cancel("Cancel");Message.ok("Yes, start again!","startagain","extrawide");$("#msg_startagain").click(function(){unsaved_changes=0;window.location=TT_URL+"write/"});Message.show()}else{unsaved_changes=0;window.location=TT_URL+"write/"}}function open_list(){if(allow_save==true?unsaved_changes==0:false){Message.html("<h2>Save before opening a different story?</h2>");Message.cancel("Cancel");Message.ok("Don't save","dontsave","wide");Message.ok("Save","save","wide");$("#msg_save").click(function(){save();get_saved_text_list_queued=true});$("#msg_dontsave").click(function(){get_saved_text_list()});Message.show()}else{get_saved_text_list()}}function open_text(a){$.post("open.php",{story_id:a},function(b){reset();var c=make_editable(b.content);$("#telescopictext_edit").html(c);set_gaps();$("#first_save").val("0");$("#story_id").val(b.id);$("#publish_story_id").val(b.id);time_since_opened();$("#story_title").text(b.title);$("#title").val(b.title);make_structure();check_folded();fold();Allow.Delete(true);Allow.revert(true);Allow.duplicate(true);Allow.save(true);Allow.publish(true);unsaved_changes=0;Message.hide();$("#footer").hide();if($("#start_story").is(":visible")){$("#start_story").hide()}},"json")}function revert(){open_text($("#story_id").val())}function get_saved_text_list(){get_saved_text_list_queued=false;$.post("open-list.php",{author_id:$("#author_id").val()},function(c){Message.empty();if(c.length==0){Message.html("<h2>You have no saved Texts</h2>")}else{var a="",b;for(b=0;b<c.length;b++){if(c[b].id==$("#story_id").val()){a=a+"<div class='text_not_openable'><span class='text_not_openable_title'>"+c[b].title+"</span><span class='text_not_openable_message'>Currently open</span></div>"}else{a=a+"<div class='storyforload'><span class='story_title' onclick='open_text("+c[b].id+")'>"+c[b].title+"</span><span id='delete_"+c[b].id+"' class='delete_holder'><span class='delete button red' onclick='deletestory("+c[b].id+")'>delete</span></span></div>"}a=a+"<div class='saved_text_date'>Last saved "+c[b].last_modified+"</div>"}Message.html("<h2>Open a saved Text</h2>"+a)}Message.cancel("cancel");$(".storyforload").bind("mouseenter",function(){$(this).children(".delete_holder").show();$(".delete_holder .delete").show()});$(".storyforload").bind("mouseleave",function(){var d=$(this).children(".delete_holder");d.children(".really_delete, .cancel").remove();d.hide()})},"json");Message.show()}function start_new_text(){$("#telescopictext_edit").empty();id_counter=0;reset();$("#start_story").show();check_folded();$("#footer").show();$("#firsttextinput").focus()}function deletestory(b,a){if(a!=undefined){if(a==true){$.post("delete.php",{story_id:b},function(c){if(c=="1"){start_new_text();allow_save=false;open_list()}},"text")}else{if(a==false){$("#delete_"+b+" .really_delete, #delete_"+b+" .cancel").remove()}}}else{$("#delete_"+b+" .delete").hide();$("#delete_"+b).prepend("<span class='really_delete button red wide' onclick='deletestory("+b+",true)'>really delete</span>");$("#delete_"+b).prepend("<span class='cancel button' onclick='deletestory("+b+",false)'>cancel</span>")}}function confirm_delete(){if(allow_delete==true){Message.html("<h2>Really delete &#8220;"+$("#story_title").text()+"&#8221;?</h2>Deleting a saved Text is irreversible.");Message.cancel("Cancel");Message.ok("Delete","delete","red wide");$("#msg_delete").click(function(){Message.html("<h2>Deleting...</h2>");Message.show();deletestory($("#story_id").val(),true)});Message.show()}}function enter(c){appending=true;remove_mode(false);$(document).stopTime("add_utilities");removeInputs();var a=c.text(),b,d;c.wrapInner("<span class='hide_while_appending' style='display:none;'></span>");$("<span></span>").attr({id:"textinput",contenteditable:"true"}).text(a).appendTo(c);$("#oldinner span").empty().append(c.children(":first").text());b=c.children(":first").text();$("#oldinner span").click(function(){$("#textinput").text(a);set_append(c,true);set_caret()});$("#canceladd").click(function(){cancel_append()});$("#add").click(function(){append(c,b,a)});$("#story").css("color","#999");$("#append").show();set_caret();disable_gaps();disable_append();Allow.fold(false);Allow.unfold(false);$(".b").addClass("__b").removeClass("b");$("#textinput").nextALL("#spacer, .space").eq(0).click(function(){set_caret()});$("#textinput").prevALL(".space").eq(0).click(function(){set_caret("start")});set_append(c,true);d=$("#textinput").html();$(document).everyTime(50,"add_utilities",function(){if($("#textinput").html()!=d){set_append(c);d=$("#textinput").html()}})}function show_brackets(b,h){if(h?h==true:false){$("#brackets").show()}var g=b.prevALL(".space, .join").eq(0),d=b.position().top,e,c,a,f;if(g.html()!=null?(g.position().top+10)==d:false){e=g.position().left+g.width()}else{e=b.position().left}$("#left_bracket").css({top:d-10,left:e-1});c=b.position().left+b.width();a=b.position().top;f=b.nextALL(".space, .join").eq(0);if(f.html()!=null){if(f.width()==0){f.html("&nbsp; ")}if(f.position().top+10==f.nextALL().eq(0).position().top){f.html(" ");if(f.width()==0){f.html("&nbsp; ")}}c=f.position().left;a=f.position().top+10}else{if(f.html()==null){c=$("#spacer").position().left;a=$("#spacer").position().top}}$("#right_bracket").css({top:a-10,left:c-1})}function set_append(d,a){show_brackets(d,a);var f=d.nextALL("#spacer, .space").eq(0).position(),j=d.width(),e=$("#add_holder"),b=$("#left_bracket").position().top,i=$("#left_bracket").position().left,k=$("#right_bracket").position().top,l=$("#right_bracket").position().left,c,h,g;if(j<e.outerWidth()){h=l-((e.outerWidth()/2)+(j/2))}else{h=l-(e.outerWidth()-5)}if(h<0){h=0}if(h+e.outerWidth()>$("#story").width()){h=$("#story").width()-e.outerWidth()}g=k+53;e.css({top:g,left:h});if(d.prevALL(".space").eq(0).html()==null){f=d.position()}else{f=d.prevALL(".space").eq(0).position()}if(b!=k){j=$("#story").width()-i}if(j<($("#old>span>span").width()+12)){$("#old>span").css({padding:"6px 0 0 0"});$("#old").css({top:b-10,left:i}).width($("#old>span>span").width())}else{$("#old>span").css({padding:"6px 6px 0 6px"});$("#old").css({top:b-10,left:i}).width(j)}c=$("#add_holder").position().top-$(window).height()-$(window).scrollTop()+216+4;if(c>0){window.scrollBy(0,c)}}function append(e,a,d){remove_mode(false);var f=$("#textinput").html(),c,b;if(f.match(/<[^>]*>/)){f=f.strip_html_tags();f=f.replace(/&nbsp;/g," ");if(f.match(/<br>|<br \/>/)){f=f.replace(/<br>|<br \/>/g,"\n")}$("#textinput").html(f);testy=$("#textinput").text()}c=$("#textinput").text();b=c.trim();if(b==undefined||b==null||b==""){$("#textinput").text($("#oldinner span").text());warning("#textinput","You must write something",36);set_caret()}else{if(b==$("#oldinner span").text()){warning("#textinput","You must either add to or change these words",36);set_caret()}else{appending=false;enable_append();$(document).stopTime("add_utilities");e.nextALL(".space, .join").eq(0).html(" ");e.empty().attr({id:id_counter,"class":"a"}).html("<span class='b'>"+a+"</span><span class='c'>"+split_words(c)+"</span>");e.children(".b").hide();set_gaps();removeInputs();check_folded();$(".__b").addClass("b").removeClass("__b");make_structure(e);id_counter++;Allow.save(true);Allow.publish(true);unsaved_changes++;$("#last_saved").css("color","#f05454");if(unsaved_changes>1){$("#last_saved span").text(" ("+unsaved_changes+" changes)")}else{$("#last_saved span").text(" ("+unsaved_changes+" change)")}}}}function cancel_append(){if(appending==true){appending=false;var a=$(".hide_while_appending"),b=a.html();enable_append();$(document).stopTime("add_utilities");removeInputs();a.parent().nextALL(".space, .join").eq(0).html(" ");a.parent().html(b);set_gaps();check_folded();$(".__b").addClass("b").removeClass("__b")}}function disable_gaps(){$(".join").addClass("space").removeClass("join").unbind()}function disable_append(){$(".text").addClass("_no_children").removeClass("text")}function enable_append(){$("._no_children").addClass("text").removeClass("_no_children")}function set_gaps(){$(".space").addClass("join").removeClass("space");$(".a").each(function(){var a=$(this);a.prev(".join").removeClass("join").unbind().addClass("space");a.next(".join").removeClass("join").unbind().addClass("space")})}function start_text(){if(text_started==false){var b=$("#firsttextinput").val(),a;if(b.length>maximum_starting_length){$("#firsttextinput").val(b.substr(0,maximum_starting_length));warning("#firsttextinput","Too many letters")}else{if(key_pressed==false&&initial_text==true){a=escape_string(b);if(a!=""){$("#story_title").text(a);$(split_words(b)).appendTo("#telescopictext_edit");$("#title").val(a);$("#start_story").fadeOut();make_structure();$("#footer").hide();Allow.Delete(false);Allow.revert(false);Allow.duplicate(false);unsaved_changes=0;text_started=true;time_since_started()}else{warning("#firsttextinput","Not valid starting text")}}}}}function expand(a){if(global_key==85){var b=a.attr("id");$("#"+b+" .c, #"+b).show();$("#"+b+" .b").hide();removeInputs();check_folded()}else{a.children(".b").hide();a.children(".c").show();check_folded()}}function fold(){if(allow_fold==true){$(".c").hide();$(".a, .b").show();removeInputs();check_folded()}}function unfold(){if(allow_unfold==true){$(".c, .a").show();$(".b").hide();removeInputs();check_folded()}}function removeInputs(){$("#story").css({color:"#000000"});$("#textinput").parent().children().show();$("#textinput, #bookendright").remove();$("#canceladd, #add").unbind();$("#append, #brackets").hide()}String.prototype.trim=function(){return this.replace(/^[^\n\S]*|[^\n\S]*$/g,"")};String.prototype.preserve_html=function(){var a=this.replace(/&(?=#?[^;&]+;)/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a};String.prototype.remove_multiple_white_space=function(){return this.replace(/[^\n\S]{2,}/g," ")};String.prototype.strip_html_tags=function(){return this.replace(/<br[ \/]*>(?=<br[ \/]*>)|<(?!br \/>|br>)[^>]*>/g,"")};function escape_string(a){a=a.remove_multiple_white_space();a=a.trim();a=a.preserve_html();return a}function split_words(a){a=escape_string(a);var d=a.match(/\s*\n+\s*|\s+|\S+/g),c="",b;for(b=0;b<d.length;b++){if(d[b].match(/\s*\n+\s*/)!=null){c=c+d[b].replace(/\s*\n+\s*/g,line_break)}else{if(d[b].match(/[\S]+/)!=null){c=c+"<span class='text'>"+d[b]+"</span>"}else{if(d[b].match(/[\s]+/)!=null){c=c+"<span class='join'> </span>"}}}}return c}function bridge(b){var c=b.prev(),a=b.next(),d=c.html()+"<span class='break'>"+b.html()+"</span>"+a.html();c.remove();a.remove();b.attr("class","text").html(d)}function unbridge(b){var d=b.html(),c=b.parent(),a;b.replaceWith("<gap>");a=c.html();a=a.replace("<gap></gap>","</span><span class='join'>"+d+"</span><span class='text'>");a="<span class='text'>"+a+"</span>";c.replaceWith(a)}function make_XML(){var b=$("#telescopictext_edit").children(":first"),c=false,a="";while(c==false){if(b.hasClass("a")||b.hasClass("c")){b=b.children(":first")}else{if(b.hasClass("text")||b.hasClass("space")){if(b.html().match(/<[^>]*>/)){a=a+b.html().replace(/<[^>]*>/g,"")}else{a=a+b.html()}if(b.next().html()==null){while(b.next().html()==null){b=b.parent();if(b.hasClass("c")){a=a+"</c></a>";b=b.parent()}if(b.is("#telescopictext_edit")){c=true}}}}else{if(b.hasClass("join")){a=a+b.html()}else{if(b.hasClass("b")){a=a+"<a><b>"+b.html()+"</b><c>"}else{if(b.hasClass("line_break")){a=a+"<break />"}}}}b=b.next()}}$("#thetelescopictext").val(a)}function make_structure(b){var d=false,a,c;if(b?b.parent().attr("id")!="telescopictext_edit":false){b=b.parent()}else{b=$("#telescopictext_edit")}c=b.children(":first");a="<div class='structure_text'>";while(d==false){if(c.hasClass("a")||c.hasClass("c")){if(c.hasClass("a")){a=a+"</div><div id='s"+c.attr("id")+"' class='structure_node'>"}c=c.children(":first")}else{if(c.hasClass("text")||c.hasClass("space")||c.hasClass("join")){a=a+c.html();if(c.next().html()==null){while(c.next().html()==null){c=c.parent();if(c.hasClass("c")){a=a+"</div></div></div><div class='structure_text'>"}if(c.attr("id")=="telescopictext_edit"||c.parent().attr("id")==b.parent().attr("id")){d=true}}}}else{if(c.hasClass("b")){a=a+"<div class='structure_title'><div class='structure_left_bracket'></div><span class='structure_title_text'><span>"+c.html()+"</span></span><div class='structure_right_bracket'></div></div><div class='structure_content'><div class='structure_text'>"}}c=c.next()}}a=a+"</div>";a=a.replace("<div class='structure_text'></div>","");if(b.attr("id")=="telescopictext_edit"){output_structure(a)}else{output_structure(a,"s"+b.parent().attr("id"))}}function output_structure(a,c){if(c==undefined){c="#text_structure_window .text_structure"}else{c="#text_structure_window .text_structure #"+c+" .structure_content"}$("#text_structure_window .text_structure_container").css("width","100000px");$("#text_structure_window .text_structure").width("auto");$(c).html(a);$(c+" .structure_node, "+c+" .structure_text").each(function(){var d=$(this);if(d.next().html()!=null?d.next().text()!="":false){d.addClass("structure_spacer")}d.outerWidth(d.outerWidth())});var b=$("#text_structure_window .text_structure").width();$("#text_structure_window .text_structure").width(b+5);$("#text_structure_window .text_structure_container").width(b+5)}function make_editable(a){id_counter=0;var d="",c=a.match(/<b>[^<]*<\/b>|[ ]*<break \/>[ ]*|<[^>]*>|[ ]+|[^ <>]+/g),b;for(b=0;b<c.length;b++){if(c[b].match("<break />")!=null){d=d+line_break}else{if(c[b].charAt(0)=="<"){if(c[b].match("<a>")!=null){d=d+"<span id='"+id_counter+"' class='a'>";id_counter++}else{if(c[b].match("</a>")!=null){d=d+"</span>"}else{if(c[b].match("<c>")!=null){d=d+"<span class='c'>"}else{if(c[b].match("</c>")!=null){d=d+"</span>"}else{if(c[b].match("<b>")!=null){d=d+"<span class='b'>"+c[b].replace(/<b>|<\/title>/g,"")+"</span>"}}}}}}else{if(c[b].match(/[^ ]+/)!=null){d=d+"<span class='text'>"+c[b]+"</span>"}else{d=d+"<span class='join'> </span>"}}}}return d}function save(){if(allow_save==true){Message.html('<h2 class="loading">Saving...</h2>');Message.show("save")}}function really_save(){make_XML();var a={url:"save.php",success:save_response};$("#save").ajaxSubmit(a);return false}function really_save_for_publish(){make_XML();var a={url:"save.php",success:really_publish};$("#save").ajaxSubmit(a);return false}function publish(){if(allow_save==true?allow_publish==true:false){Message.html('<h2 class="loading">Saving...</h2>');Message.show("publish")}}function duplicate(){save();if(allow_duplicate==true){Message.html('<h2 class="loading">Duplicating...</h2>');Message.show();$.post("duplicate.php",{text_id:$("#story_id").val()},function(a){Message.hide()},"xml")}}function confirm_publish(){if(allow_save==true?allow_publish==true:false){Message.html("<h2>Publish &#8220;"+$("#story_title").text()+'&#8221;?</h2><h3 style="margin:0 0 12px 0;">Publishing your text gives it a unique URL, however you won&apos;t be able to remove or edit it again.</h3><h4 style="margin:0 0 6px 0">1. Publishing checklist</h4><h3><input type="checkbox" class="publish_checklist"></input>&nbsp; My Telescopic Text is finished</h3><h3><input type="checkbox" class="publish_checklist"></input>&nbsp; The spelling and grammar is correct</h3><h3><input type="checkbox" class="publish_checklist"></input>&nbsp; I know I can\'t edit or remove my Telescopic Text once it&apos;s published</h3><h3><input type="checkbox" class="publish_checklist"></input>&nbsp; I&apos;ve read the <a href="/resources/terms-of-service" title="Terms of Service for Telescopic Text" target="_blank">Terms of Service</a> and I agree to them</h3><h4 style="margin:12px 0 6px 0">2. Privacy (set to private if you don&apos;t want your text to be considered for display on the Texts page.)</h4><h3><input type="radio" name="publish_private" value="1" />&nbsp; Private&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="publish_private" value="0" />&nbsp; Public</h3>');Message.cancel("Cancel");Message.ok("Publish","publish","blue wide");$("#msg_publish").click(function(){var a=$("input[name='publish_private']:checked").val();msg="";bool=0;$(".publish_checklist").each(function(){if($(this).is(":not(:checked)")){bool=1}});if(bool==1){msg=msg+"—One or more of the items on the publishing checklist have not been checked\n\r"}if(a==undefined){msg=msg+"—You must select either 'Private' or 'Public'\n\r"}else{if(a=="0"){$("#private").val("0")}else{if(a=="1"){$("#private").val("1")}}}if(msg!=""){alert(msg)}else{publish()}});Message.show()}}function really_publish(b){saved(b);if(allow_publish==true){Message.html('<h2 class="loading">Publishing...</h2>');Message.show();var a={url:"publish.php",success:publish_response};$("#publish").ajaxSubmit(a)}return false}function show_preview(){if(allow_preview==true){cancel_append();view_normal(0);$("#story_line_top, #story_line_bottom").hide();$("#story").css("marginTop","").removeClass("half_width").addClass("full_width").show();fold();remove_mode(false);toggle_editing(false);$("._b").addClass("_node_title");$("#story").stop().animate({marginTop:"60px"},100);$("#menu_holder").stop().animate({top:"-21px"},100);$("#story_info").hide();$("#back_to_editing").remove();$("<span>Edit</span>").attr({"class":"underline",id:"back_to_editing",style:"margin-right:0;"}).appendTo("#w_footer").show();$("#back_to_editing").click(function(){hide_preview()});$(document).keydown(function(a){if(a.which==27){hide_preview()}});$("#menu_left").children().fadeOut(100);$("#menu_right").children().fadeOut(100);$("#view_normal, #view_split, #view_structure, #view_normal_selected, #view_split_selected, #view_structure_selected").hide();editing=false;Allow.help(false)}}function hide_preview(){if(allow_preview==true){$("._b").removeClass("_node_title");$("#story").stop().animate({marginTop:"108px"},100,function(){view_normal()});$("#menu_holder").stop().animate({top:"27px"},100);$("#back_to_editing").remove();$("#story_info").show();$("#menu_left").children(":not(#empty_btn)").fadeIn(100);$("#menu_right").children().fadeIn(100);editing=true;toggle_editing(true);Allow.help(true)}}function backwards_mode(){var a="in";$(".c").live("click",function(){var b=$(this);if(a=="out"&&b.hasClass("_node_content")){b.hide();b.parent().children(".__b").show();$(".c:parent:not(:has(.c:visible)), .c:empty:visible").addClass("_node_content");if(editing==true){check_folded();set_gaps()}}});$(window).keydown(function(b){if(appending==false){key_pressed=true;if(b.keyCode==18){if(current_mouse_over?current_mouse_over.hasClass("join"):false){roll_out_gap(current_mouse_over)}a="out";$(".b").css("backgroundColor","transparent");$(".c:parent:not(:has(.c:visible)), .c:empty:visible").addClass("_node_content");$(".b").addClass("__b").removeClass("b");if(editing==true){toggle_editing(false);$("#help").hide();Allow.fold(false);Allow.unfold(false);remove_mode(false)}else{$(".b").removeClass("__b")}}}}).keyup(function(b){if(appending==false){key_pressed=false;if(b.keyCode==18){a="in";$(".c").removeClass("_node_content");$(".__b").addClass("b").removeClass("__b");if(editing==true){toggle_editing(true);$("#help").hide();Allow.fold(true);Allow.unfold(true);check_folded();set_gaps()}else{$(".__b").addClass("b")}$(".b").css("backgroundColor","")}}})}function remove_mode(a){if(a==undefined){if(deleting=="off"){a=true}else{a=false}}if(a==false){deleting="off";$("#empty_btn").removeClass("red");$(".structure_title").removeClass("remove")}else{if(a==true){deleting="on";$("#empty_btn").addClass("red");$(".structure_title").addClass("remove")}}}function empty(c){var a=$("#"+c),b=a.children(".b").html();$(split_words(b)).insertAfter(a);a.remove();set_gaps();check_folded();unsaved_changes++;$("#last_saved").css("color","#f05454");if(unsaved_changes>1){$("#last_saved span").text(" ("+unsaved_changes+" changes)")}else{$("#last_saved span").text(" ("+unsaved_changes+" change)")}remove_mode(false);make_structure()}function toggle_editing(a){if(a==true){$("._no_children").addClass("text").removeClass("_no_children");$("._joinable_gap").addClass("join").removeClass("_joinable_gap");$("._gap").addClass("space").removeClass("_gap")}else{if(a==false){$(".text").addClass("_no_children").removeClass("text");$(".join").addClass("_joinable_gap").removeClass("join");$(".space").addClass("_gap").removeClass("space")}}}function view_normal(a){if(a==undefined){a==200}remove_mode(false);$("#empty_btn").fadeOut(200);$("#view_normal, #view_split_selected, #view_structure_selected").hide();$("#view_normal_selected, #view_split, #view_structure").show();$("#text_structure_window").animate({left:"100%",marginLeft:""},a,function(){$("#text_structure_window").removeClass("half_screen").removeClass("full_screen")});$("#story").css("marginTop","").removeClass("half_width").addClass("full_width").show();if($("#story_line_top").is(":visible")){$("#story_line_top, #story_line_bottom").animate({right:"100%"},a)}Allow.fold(true);Allow.unfold(true);check_folded()}function view_split(){$("#empty_btn").fadeIn(200);$("#view_normal_selected, #view_split, #view_structure_selected").hide();$("#view_normal, #view_split_selected, #view_structure").show();$("#story").css("marginTop","0").removeClass("full_width").addClass("half_width").show();$("#text_structure_window").animate({left:"50%",marginLeft:""},200,function(){$("#text_structure_window").removeClass("full_screen").addClass("half_screen")});$(".text_structure").css({left:"0",top:"0"});$("#story_line_top, #story_line_bottom").show().animate({right:"50%"},200);Allow.fold(true);Allow.unfold(true);check_folded()}function view_structure(){$("#empty_btn").fadeIn(200);$("#view_normal_selected, #view_split_selected, #view_structure").hide();$("#view_normal, #view_split, #view_structure_selected").show();$("#text_structure_window").animate({left:"0%",marginLeft:"36px"},200,function(){$("#text_structure_window").removeClass("half_screen").addClass("full_screen")});$("#story").fadeOut(200);$("#story_line_top, #story_line_bottom").hide();$(".text_structure").css({left:"0",top:"0"});Allow.fold(false);Allow.unfold(false)}function allowClass(){var c,a,b;this.save=function(d){c="#save_btn";a="lightblue";allow_save=d?true:false;this.set_allow(d)};this.publish=function(d){c="#publish_btn";a="blue";allow_publish=d?true:false;this.set_allow(d)};this.preview=function(d){c="#secondary_preview_btn";a="underline";allow_delete=d?true:false;this.set_allow(d)};this.Delete=function(d){c="#secondary_delete_btn";a="underline";allow_delete=d?true:false;this.set_allow(d)};this.revert=function(d){c="#revert_btn";a="underline";allow_revert=d?true:false;this.set_allow(d)};this.duplicate=function(d){c="#duplicate_btn";a="underline";allow_duplicate=d?true:false;this.set_allow(d)};this.help=function(d){allow_help=d?true:false;this.set_allow(d)};this.undo=function(d){c="#undo_btn";a="green";allow_undo=d?true:false;this.set_allow(d)};this.redo=function(d){c="#redo_btn";a="green";allow_redo=d?true:false;this.set_allow(d)};this.fold=function(d){c="#fold_btn";a="green";allow_fold=d?true:false;this.set_allow(d)};this.unfold=function(d){c="#unfold_btn";a="green";allow_unfold=d?true:false;this.set_allow(d)};this.set_allow=function(d){b=a+"-disabled";if(d!=undefined?d==true:false){$(c).toggleClass(b,false).toggleClass(a,true)}else{$(c).toggleClass(b,true).toggleClass(a,false)}}};